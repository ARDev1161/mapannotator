# Сравнение Map Annotator и статьи Sharif et al. (arXiv:2303.13798)

## Цели и контекст

| Характеристика | Map Annotator | Sharif et al., 2023 |
| --- | --- | --- |
| Основная цель | Семантическая сегментация карты, построение графа зон, генерация PDDL и ROS 2 публикация | Быстрая и робастная геометрическая сегментация карт для уборочных роботов и бенчмарков |
| Формат входа | PGM + `map.yaml` или ROS 2 `OccupancyGrid` | Occupancy grid из SLAM (PGM/PNG) |
| Выход | Структурированный zone graph, классы зон (`config/rules.yaml`), PDDL, визуализация | Сегментация как размеченная карта + граф смежности после эвристических слияний |
| Целевая интеграция | Планировщики, навигация, ROS 2 стеки | Встроенные алгоритмы Neato, исследовательские сравнения |

## Архитектура пайплайна

### Map Annotator

1. **Предобработка** (`preparing/mappreprocessing.hpp`, `utils.hpp`).
   - Выравнивание (`MapPreprocessing::mapAlign`), денойзинг (`generateDenoisedAlone`), морфологические операции (`erodeBinary`/`dilateBinary`).
   - Использование `map.yaml` для установки `MapInfo` и метрик переводов между пикселями и миром (`utils.hpp`).
2. **Сегментация** (`map_processing.cpp`).
   - `segmentByGaussianThreshold` выполняет итеративную гауссову фильтрацию и пороговую сегментацию по свободным пикселям, но **сохраняет исходные центроиды** из `LabelMapping` и довороточивает зоны через `attachPixelsToNearestZone`, `mergeLonelyFreeAreas`, `keepCentroidComponent`.
   - `labelsOut` задаётся в двух местах по двум веткам алгоритма: если включён `useDownsampleSeeds`, то центроиды и маски берутся из даун-семпл семян и сразу собираются `buildLabelsFromZones` (legacy не используется); если семян нет или выключены, запускается legacy-цикл (Gaussian+threshold+extractIsolatedZones), и только по его завершении финальные маски снова конвертируются в `buildLabelsFromZones`.
   - Работает с бинаризованной свободной областью, акцент на сохранении контуров препятствий через `wallMask`.
3. **Граф зон** (`mapgraph/`).
   - `buildGraph` вычисляет смежность по пиксельным маскам, переводит центры в мировые координаты (`pixelToWorld`), создаёт `ZoneGraph`, запускает `ZoneClassifier` на основе `config/rules.yaml` и сохраняет DOT/PNG.
4. **Семантический вывод**.
   - `PDDLGenerator` формирует доменно-независимые блоки `:objects`, `:init`, `:goal`.
   - ROS 2 нода (`ros2_node.cpp`) слушает `/map`, публикует PDDL и визуализацию.
5. **Конфигурация**.
   - YAML-параметры для правил классификатора, ROS 2 параметры для порогов сегментации, имён топиков и т.д.

### Sharif et al. (Down-sampling based 2D FPS)

1. **Предобработка** (раздел III-A).
   - Бинаризация, удаление мелких компонент, выравнивание карт через Hough линии, Meijering ridge фильтр.
2. **Формирование семян через даун-семплинг** (III-B).
   - Итеративный гауссов фильтр с увеличением σ ≥ 1, threshold=0.95, фиксация «seed map» на каждой итерации.
   - Анализ birth/death событий семян по мере деления областей; хранение только листьев графа семян.
3. **Over-segmentation** (III-C).
   - Суперпозиция листовых семян служит маркерами для Watershed по карте рёбер (Meijering), что обеспечивает сохранение границ.
4. **Слияние** (III-D).
   - Построение графа смежности, три эвристики: удаление маленьких листов, слияние с соседом по максимальной границе, объединение по длинным границам (>3 м).
5. **Оценка** (IV-A).
   - Комплекс метрик (Recall/Precision из [4], Completeness/Homogeneity, AMI/NMI, IoU, Under-painting). Нет семантики поверх сегментации.

## Сходства

- **Опора на классические CV-пайплайны**. Обе системы используют гауссов фильтр, бинаризацию, морфологию и приёмы упрощения карты без обучения.
- **Выравнивание карты**. В обоих подходах есть модуль детектирования доминирующих направлений (Hough) и приведение карты к ортогональному виду.
- **Многопроходный процесс**. MAPAnnotator сегментирует в цикле по σ и затем дорабатывает зоны; статья — через последовательные seed maps и пост-обработку.
- **Графовое представление сегментов**. Оба строят граф смежности для усиления/TSP и последующих шагов (в статье для слияний, у нас — для классификации и PDDL).

## Ключевые различия и оценка

| Аспект | Map Annotator | Sharif et al. | Комментарий |
| --- | --- | --- | --- |
| **Алгоритм сегментации** | Итеративные пороги свободного пространства + «прилипание» пикселей к ближайшей зоне; нет Watershed | Watershed по суперпозиции листовых семян; сильный контроль над topological birth/death | Sharif уделяет больше внимания корректному seed tracking, у нас упор на сохранение центроидов и корректную постобработку масок |
| **Работа с препятствиями** | Явно строится `wallMask`, препятствия исключаются после расширения стен | Обработка препятствий через бинаризацию и удаление мелких компонент, далее все в одном канале | Маска стен позволяет Map Annotator рисовать граф поверх «проходов» и отделять PDDL, но требует аккуратного выбора параметров диляции |
| **Семантика** | `ZoneClassifier` (иерархия типов, признаки площади/ширины/соседей) + PDDLGenerator, ROS 2 интеграция | Только геометрическая сегментация + базовые графовые статистики; метрики качества, но без классов | Map Annotator нацелен на автономное планирование, Sharif — на базовое деление карты |
| **Конфигурация и расширяемость** | YAML/ROS параметры, модульная архитектура (segmentation, graph, pddl), возможность запускать как CLI или ROS 2 | Monolithic Python/CV пайплайн, параметры зашиты в код/скрипт; нет ROS или планировщиков | Наш проект легче интегрировать в стек робота, но сложнее в настройке |
| **Оценка и валидация** | Нет встроенного набора метрик; визуальная отладка и вывод PDDL/DOT | Подробное сравнение на бенчмарке [4], анализ 11 метрик | Статья сильнее в формальной оценке, Map Annotator требует собственных тестов |
| **Производительность** | Разнородный C++ код; heavy OpenCV, но оптимизирован; ROS 2 real-time | Фокус на быстроте за счёт фильтра + Watershed; среднее время ~10 с на CPU | Наш pipeline более сложный (классификация, граф), возможно тяжелее, зато даёт больше артефактов для планирования |
| **Выходы** | `graph.dot`, `graph_preview.png`, PDDL, ROS topics | Размеченные карты и статистика качества | Дополнительные форматы Map Annotator упрощают интеграцию с планировщиками |

## Преимущества Map Annotator относительно подхода Sharif et al.

1. **Семантика и планирование** — наличие `config/rules.yaml`, `ZoneClassifier` и `PDDLGenerator` позволяет напрямую связать карту с задачами планирования (например, целевые комнаты, стартовые зоны), чего нет в статье.
2. **ROS 2 совместимость** — `ros2_node.cpp` делает пайплайн потоковым компонентом в роботе; статья рассчитана на офлайн обработку.
3. **Обработка стен** — явная маска препятствий + визуализация делают результат понятным оператору и алгоритмам планирования маршрутов.
4. **Устойчивость центроидов** — функции `keepCentroidComponent`, `attachPixelsToNearestZone`, `mergeLonelyFreeAreas` уменьшают риск «дрейфа» сегментов при сложных геометриях.
5. **Прозрачность конфигурации** — параметры (erosion kernel, sigma step, thresholds) задаются через YAML/ROS, что удобнее для эксплуатации.

## Преимущества подхода Sharif et al.

1. **Строгий контроль birth/death семян** — отслеживание жизненного цикла каждого seed и использование только «листов» снижает риск пере-сегментации.
2. **Watershed по ridges** — использование Meijering фильтра для формирования границ даёт более четкое соответствие коридорам и стенам на шумных картах.
3. **Лаконичные слияния** — три простых эвристики (площадь/граница) дают воспроизводимый результат без сложных процедур прилипания.
4. **Подробная метрика качества** — таблицы с Recall/Precision/AMI/NMI и обсуждение under-painting помогают объективно сравнивать алгоритмы.
5. **Публичные бенчмарки** — авторы тестируют на наборах Bormann et al. и реальных карт Neato, что упрощает сопоставление результатов.

## Слабые места

- **Map Annotator**: нет встроенных оценок качества, сложная конфигурация, зависимости от `map.yaml` и ручных правил могут ограничивать переносимость; сегментация без Watershed хуже контролирует геометрию узких коридоров.
- **Sharif et al.**: отсутствие семантики, ROS и планировочных выходов; чувствительность к параметрам σ и порогу 0.95; эвристические метрики площади могут ошибаться на открытых пространствах; код ориентирован на офлайн batch.

## Выводы и рекомендации

- Если задача — **семантическая аннотация** для планирования, Map Annotator существенно расширяет идеи статьи: добавляет классификатор, граф зон, PDDL и онлайн-режим.
- Если требуется **офлайн сегментация с воспроизводимой метрикой**, метод Sharif et al. полезен как baseline и может использоваться для калибровки параметров Map Annotator (например, σ sweep, контроль birth/death семян, выбор метрик V-score/AMI).
- Перспективное направление: адаптировать идею суперпозиции листовых семян и Watershed-графа из статьи в модуль `segmentByGaussianThreshold`, чтобы снизить пере-сегментацию длинных коридоров, и добавить измерение completeness/homogeneity для автоматической валидации в Map Annotator.
